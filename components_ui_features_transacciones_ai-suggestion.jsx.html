<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/ui/features/transacciones/ai-suggestion.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/ui/features/transacciones/ai-suggestion.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * AI-powered financial suggestion component for analyzing user transactions.
 *
 * @component
 * @remarks
 * This component fetches the user's financial goals and transactions to generate strategic
 * suggestions using an AI model. It uses `useTransactionContext` to access transactions
 * and retrieves goals from IndexedDB. The AI suggestions are displayed in a collapsible UI.
 *
 * @returns {JSX.Element} The rendered component containing a button to trigger suggestions
 * and a UI for displaying the AI-generated recommendations.
 *
 * @example
 * // Usage in a parent component
 * import AISuggestion from "@/components/ui/features/transacciones/ai-suggestion";
 *
 * function Dashboard() {
 *   return &lt;AISuggestion />;
 * }
 */
import { useState, useEffect } from "react";
import { generateFinancialSummary } from "@/utils/gemini";
import { getGoals, getBudget } from "@/db/db";
import { isDateInNowMonth } from "@/lib/utils";
import Markdown from "react-markdown";
import remarkGfm from "remark-gfm";
import { RefreshCcw, X, WandSparkles, Mic, Play, Square } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useTransactionContext } from "@/context/TransactionContext";
import AiChat from "./ai-chat";
import { getSpeechServices } from "@/utils/speechServices";

export default function AISuggestion() {
  const { iaTransactions } = useTransactionContext();
  const [suggestion, setSuggestion] = useState("");
  const [loading, setLoading] = useState(false);
  const [showSuggestion, setShowSuggestion] = useState(false);
  const [metaAhorro, setMetaAhorro] = useState(null);
  const [presupuesto, setPresupuesto] = useState(null);
  const [showChat, setShowChat] = useState(false);
  const { tts } = getSpeechServices();
  const [playing, setPlaying] = useState(false)

  useEffect(() => {
    async function fetchGoals() {
      try {
        const goals = await getGoals();
        setMetaAhorro(goals);
        const _goals = goals.filter((g) => isDateInNowMonth(g.targetDate));
        setMetaAhorro(_goals[0]?.amount ?? null);
      } catch (error) {
        console.error(
          error?.message ?? "An error occurred while fetching the goals.",
        );
      }
    }

    fetchGoals();

    async function fetchBudget() {
      try {
        const data = await getBudget();
        setPresupuesto(data[0]?.amount ?? null);
      } catch (error) {
        console.error(
          error?.message ?? "An error occurred while fetching the budget",
        );
      }
    }
    fetchBudget();
  }, []);

  /**
   * Generates and displays a financial summary suggestion based on available transactions.
   *
   * @throws {Error} Throws an error if required transaction data is missing.
   * @returns {Promise&lt;void>} Resolves when the suggestion has been generated and displayed.
   *
   * @example
   * // Assuming iaTransactions, metaAhorro, and presupuesto are already defined:
   * await getIASuggestion();
   */
  async function getIASuggestion() {
    if (!iaTransactions || iaTransactions.length === 0) {
      alert("No hay transacciones para analizar.");
      return;
    }
    setLoading(true);
    setSuggestion("");
    const response = await generateFinancialSummary(
      iaTransactions,
      metaAhorro,
      presupuesto,
    );
    setSuggestion(response);
    tts.speak(response, undefined, () => { setPlaying(false) })
    setPlaying(true)
    setLoading(false);
    setShowSuggestion(true);
  }

  /**
   * Handles the text-to-speech (TTS) playback of a suggestion or a default message if no suggestion is available.
   *
   * @returns {Promise&lt;void>} Resolves when the TTS action has been triggered or canceled.
   *
   * @example
   * // Toggles TTS playback depending on the current state:
   * await handleTTS();
   */
  async function handleTTS() {
    if (playing) {
      tts.cancel()
      setPlaying(false)
    } else {
      if (suggestion == "") {
        tts.speak("Presiona generar para obtener una sugerencia", undefined, () => { setPlaying(false) })
      } else {
        tts.speak(suggestion, undefined, () => { setPlaying(false) })
      }
      setPlaying(true)
    }
  }

  return (
    &lt;div className="relative w-80">
      {!showSuggestion &amp;&amp; (
        &lt;Button
          variant="default"
          onClick={() => setShowSuggestion(true)}
          className="p-4 bg-purple-600 hover:bg-purple-700 text-white cursor-pointer"
          aria-label="Open IA Suggestion"
        >
          &lt;WandSparkles size={24} />
        &lt;/Button>
      )}
      {showSuggestion &amp;&amp; (
        &lt;div className="absolute bottom-0 left-0 max-h-80 min-w-100 max-w-140 bg-white shadow p-4 rounded-xl border border-purple-600 flex flex-col gap-3 overflow-y-auto">
          &lt;div className="flex justify-between items-center">
            &lt;div className="flex items-center gap-2">
              &lt;div className="w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center shadow">
                ðŸ¤–
              &lt;/div>
              &lt;span className="font-medium text-purple-600">Sugerencia IA&lt;/span>
            &lt;/div>
            &lt;Button
              variant="ghost"
              className="cursor-pointer"
              onClick={() => setShowSuggestion(false)}
              aria-label="Close IA Suggestion"
            >
              &lt;X size={18} />
            &lt;/Button>
          &lt;/div>
          &lt;div className="bg-gray-200 p-3 rounded-lg text-gray-800 text-sm flex-1 overflow-y-auto">
            {loading ? (
              &lt;p className="animate-pulse">Obteniendo sugerencias...&lt;/p>
            ) : suggestion ? (
              &lt;Markdown remarkPlugins={[remarkGfm]}>{suggestion}&lt;/Markdown>
            ) : (
              &lt;p className="italic">
                Presiona &amp;quot;Generar&amp;quot; para obtener una sugerencia
              &lt;/p>
            )}
          &lt;/div>
          &lt;div className="flex justify-between items-center">
            &lt;Button
              variant="default"
              onClick={handleTTS}
              className="py-2 px-4 rounded-lg flex items-center gap-2 justify-center bg-purple-600 hover:bg-purple-700 text-white cursor-pointer"
              aria-label="Start Stop TTS"
            >
              {playing ? (
                &lt;Square size={16} />
              ) : (
                &lt;Play size={16} />
              )}
            &lt;/Button>
            &lt;Button
              variant="default"
              onClick={getIASuggestion}
              disabled={loading}
              className="py-2 px-4 rounded-lg flex items-center gap-2 justify-center bg-purple-600 hover:bg-purple-700 text-white cursor-pointer w-[75%]"
              aria-label="Generate IA Suggestion"
            >
              &lt;RefreshCcw size={16} />
              {loading ? "Generando..." : "Generar sugerencia"}
            &lt;/Button>
            &lt;Button
              variant="default"
              onClick={() => setShowChat(true)}
              className="py-2 px-4 rounded-lg flex items-center gap-2 justify-center bg-purple-600 hover:bg-purple-700 text-white cursor-pointer"
              aria-label="Chat voice with IA"
            >
              &lt;Mic size={16} />
            &lt;/Button>
          &lt;/div>
          &lt;AiChat
            isOpen={showChat}
            onClose={() => setShowChat(false)}
            initialContext={{
              transacciones: iaTransactions,
              metaAhorro,
              presupuesto,
            }}
          />
        &lt;/div>
      )}
    &lt;/div>
  );
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#AppSidebar">AppSidebar</a></li><li><a href="global.html#GoalListItem">GoalListItem</a></li><li><a href="global.html#STATUS_ICONS">STATUS_ICONS</a></li><li><a href="global.html#STATUS_LABELS">STATUS_LABELS</a></li><li><a href="global.html#STATUS_STYLES">STATUS_STYLES</a></li><li><a href="global.html#STATUS_VARIANT">STATUS_VARIANT</a></li><li><a href="global.html#TRANSACTION_CATEGORIES">TRANSACTION_CATEGORIES</a></li><li><a href="global.html#TRANSACTION_TYPES">TRANSACTION_TYPES</a></li><li><a href="global.html#UserManual">UserManual</a></li><li><a href="global.html#fetchBudget">fetchBudget</a></li><li><a href="global.html#fetchExpenses">fetchExpenses</a></li><li><a href="global.html#fetchTransactions">fetchTransactions</a></li><li><a href="global.html#formatCurrency">formatCurrency</a></li><li><a href="global.html#getBorderColor">getBorderColor</a></li><li><a href="global.html#getCategoryLabel">getCategoryLabel</a></li><li><a href="global.html#getTypeLabel">getTypeLabel</a></li><li><a href="global.html#handleEdit">handleEdit</a></li><li><a href="global.html#handleFileChange">handleFileChange</a></li><li><a href="global.html#handleGenerateReports">handleGenerateReports</a></li><li><a href="global.html#handleImportReports">handleImportReports</a></li><li><a href="global.html#handleListenClick">handleListenClick</a></li><li><a href="global.html#handleSubmit">handleSubmit</a></li><li><a href="global.html#handleTextDetected">handleTextDetected</a></li><li><a href="global.html#isDateInNowMonth">isDateInNowMonth</a></li><li><a href="global.html#isValidTransaction">isValidTransaction</a></li><li><a href="global.html#isValidTransactionArray">isValidTransactionArray</a></li><li><a href="global.html#loadGoals">loadGoals</a></li><li><a href="global.html#loadTransactions">loadTransactions</a></li><li><a href="global.html#onDelete">onDelete</a></li><li><a href="global.html#onSubmit">onSubmit</a></li><li><a href="global.html#transaccionSchema">transaccionSchema</a></li><li><a href="global.html#useMicVolume">useMicVolume</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Apr 22 2025 06:38:45 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
